name: Verify Invariants

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "configs/**"
      - "state/**"
      - "pipelines/**.py"
      - "scripts/**.py"
      - ".github/workflows/verify_invariants.yml"
  schedule:
    - cron: "23 2 * * *"  # daily at 02:23 UTC

permissions:
  contents: read

concurrency:
  group: verify-invariants-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip toolchain
        run: python -m pip install --upgrade pip wheel setuptools

      - name: Install requirements (minimal for checks)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install "numpy>=1.26" "scipy>=1.11" "networkx>=3.2" pandas

      - name: Ensure defaults & reports dir (Python)
        run: |
          python -c 'import os,json
os.makedirs("reports",exist_ok=True); os.makedirs("configs",exist_ok=True); os.makedirs("state",exist_ok=True)
p="configs/sigma_params.json"
if not os.path.exists(p):
    json.dump({"alpha":0.30,"lambda":0.20,"gamma":0.006,"mu":0.20,"beta":0.0,
               "theta":[0.52,0.47,0.41,0.50],
               "W":[[1.00,0.42,0.31,0.55],[0.42,1.00,0.48,0.63],[0.31,0.48,1.00,0.58],[0.55,0.63,0.58,1.00]]},
              open(p,"w"), indent=2)
m="state/last_metrics.json"
if not os.path.exists(m):
    json.dump({"sigma_percentage":0.0,"final_C":[0,0,0,0],"final_dC":[0,0,0,0],"rhoA":0.0,"dt":0.1,"timestamp":"init"},
              open(m,"w"), indent=2)'

      - name: Run invariant checks (prefer custom script)
        run: |
          if [ -f scripts/verify_invariants.py ]; then
            python scripts/verify_invariants.py
          else
            python -c 'import json,sys,os,math
params=json.load(open("configs/sigma_params.json"))
hard=[]; warn=[]
for k in ("alpha","lambda","gamma","mu","beta","theta","W"):
    if k not in params: hard.append(f"Missing key {k!r} in configs/sigma_params.json")
th=params.get("theta",[])
if not (isinstance(th,list) and len(th)==4 and all(isinstance(x,(int,float)) for x in th)):
    hard.append("theta must be a list of 4 numbers")
else:
    if not all(0.0<=float(x)<=1.0 for x in th): warn.append("theta values should be in [0,1]")
W=params.get("W",[])
if not (isinstance(W,list) and len(W)==4 and all(isinstance(r,list) and len(r)==4 for r in W)):
    hard.append("W must be a 4x4 list matrix")
else:
    sym=True
    for i in range(4):
        for j in range(4):
            if abs(float(W[i][j])-float(W[j][i]))>1e-6: sym=False; break
        if not sym: break
    if not sym: hard.append("W must be symmetric")
ag=float(params.get("alpha",0))+float(params.get("mu",0))+float(params.get("gamma",0))
if ag>1.0: warn.append(f"small_gain (alpha+mu+gamma) = {ag:.3f} is high (>1.0)")
report={"params_file":os.path.abspath("configs/sigma_params.json"),
        "metrics_file":os.path.abspath("state/last_metrics.json"),
        "small_gain":ag,"warnings":warn,"hard_errors":hard}
os.makedirs("reports",exist_ok=True)
json.dump(report,open("reports/invariants_report.json","w"),indent=2)
print(f"[INVARIANTS][{'OK' if not hard else 'FAIL'}]")
sys.exit(1 if hard else 0)'
          fi

      - name: Summarize report
        if: always()
        run: |
          if [ -f reports/invariants_report.json ]; then
            echo "### Invariants report ###" >> $GITHUB_STEP_SUMMARY
            python -c 'import json,sys; d=json.load(open("reports/invariants_report.json")); print("```json"); print(json.dumps(d,indent=2)); print("```")' >> $GITHUB_STEP_SUMMARY
          else
            echo "_No invariants report found._" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload invariant report
        uses: actions/upload-artifact@v4
        with:
          name: invariants_${{ github.run_id }}
          path: reports/invariants_report.json
          if-no-files-found: warn
