name: Run Sigma Dynamics + Autotune v2

on:
  workflow_dispatch: {}
  schedule:
    # Daily at 03:15 UTC (adjust as you like)
    - cron: "15 3 * * *"

permissions:
  contents: read

concurrency:
  group: sigma-lab-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-sigma:
    runs-on: ubuntu-latest

    env:
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      # Pour python -m pipelines.<module>
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip toolchain
        run: |
          python -m pip install --upgrade pip wheel setuptools

      - name: Install requirements
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Filets de sécurité si requirements.txt n’épingle pas tout
          pip install "numpy>=1.26" "scipy>=1.11" "networkx>=3.2" pandas matplotlib

      - name: Ensure core dirs present
        run: |
          mkdir -p configs state reports artifacts
          # Fichiers par défaut s'ils n'existent pas (évite les plantages)
          test -f configs/sigma_params.json || cat > configs/sigma_params.json <<'EOF'
          {
            "alpha": 0.30,
            "lambda": 0.20,
            "gamma": 0.006,
            "mu": 0.20,
            "beta": 0.0,
            "theta": [0.52, 0.47, 0.41, 0.50],
            "W": [
              [1.0, 0.42, 0.31, 0.55],
              [0.42, 1.0, 0.48, 0.63],
              [0.31, 0.48, 1.0, 0.58],
              [0.55, 0.63, 0.58, 1.0]
            ]
          }
          EOF
          test -f state/last_metrics.json || cat > state/last_metrics.json <<'EOF'
          {
            "sigma_percentage": 0.0,
            "final_C": [0.0, 0.0, 0.0, 0.0],
            "final_dC": [0.0, 0.0, 0.0, 0.0],
            "rhoA": 0.0,
            "dt": 0.1,
            "timestamp": "init"
          }
          EOF

      - name: Validate params & policy
        run: |
          if [ -f scripts/validate_params_and_policy.py ]; then
            python scripts/validate_params_and_policy.py
          else
            echo "[WARN] scripts/validate_params_and_policy.py not found — skipping validation"
          fi

      - name: Execute Sigma
        # Ton runner principal (assure-toi que pipelines/run_sigma.py existe)
        run: |
          python -m pipelines.run_sigma
        timeout-minutes: 30

      - name: Autotune v2 (gradient + SPSA)
        run: |
          # NOTE: garde le nom du module que TU utilises dans le repo
          # (autotune_params_v2 ou autotune_paramsv2). Ici on suit ton dernier choix.
          python -m pipelines.autotune_params_v2

      - name: Promote next params if present
        run: |
          if [ -f configs/sigma_params_next.json ]; then
            mv configs/sigma_params_next.json configs/sigma_params.json
            echo "[INFO] Promoted configs/sigma_params_next.json -> configs/sigma_params.json"
          else
            echo "[INFO] No next params to promote."
          fi

      - name: Verify Invariants
        run: |
          if [ -f scripts/verify_invariants.py ]; then
            python scripts/verify_invariants.py
          else
            echo "[WARN] scripts/verify_invariants.py not found — skipping invariants check"
          fi

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          # Copie large mais sûre
          [ -d reports ] && cp -r reports artifacts/reports || true
          [ -f state/autotune_log.csv ] && cp state/autotune_log.csv artifacts/ || true
          [ -f state/last_metrics.json ] && cp state/last_metrics.json artifacts/ || true
          [ -f configs/sigma_params.json ] && cp configs/sigma_params.json artifacts/ || true
          [ -f configs/sigma_params_next.json ] && cp configs/sigma_params_next.json artifacts/ || true
          [ -f reports/invariants_report.json ] && cp reports/invariants_report.json artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sigma_reports_${{ github.run_id }}
          path: artifacts
          if-no-files-found: warn
          retention-days: 30

      - name: Summarize Results
        run: |
          echo "✅ Sigma pipeline run #${{ github.run_number }} completed."
          if [ -f reports/invariants_report.json ]; then
            echo "→ Invariants report archived."
          fi
          if [ -f state/last_metrics.json ]; then
            echo "→ Metrics archived."
          fi
          echo "Artifacts: sigma_reports_${{ github.run_id }}"
