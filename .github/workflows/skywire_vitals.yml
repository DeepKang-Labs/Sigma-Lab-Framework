name: Skywire • Vitals capture & report

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # tous les jours à 00:00 UTC

permissions:
  contents: write

jobs:
  vitals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pyyaml pandas matplotlib
          fi

      - name: Date (UTC)
        id: date
        run: echo "date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Prepare folders
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          mkdir -p "$ARTIFACTS_ROOT/raw" "$ARTIFACTS_ROOT/sanitized"
          mkdir -p "data/${{ steps.date.outputs.date }}" "reports/latest"

      - name: Define endpoints env
        run: |
          set -euo pipefail
          echo "SKYWIRE_EXPLORER_BASE=https://skycoin.com/api" >> $GITHUB_ENV
          echo "SKYWIRE_PUBLIC_GROUP=public" >> $GITHUB_ENV
          echo "SKYWIRE_EXPLORER_GROUP=explorer" >> $GITHUB_ENV

      # ---------- Capture ----------
      - name: Run VitalSigns (produce JSON)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          python scripts/skywire_vitals.py \
            --out "artifacts/raw/skywire_vitals_${{ steps.date.outputs.date }}.json"
          cp "artifacts/raw/skywire_vitals_${{ steps.date.outputs.date }}.json" \
             "data/${{ steps.date.outputs.date }}/skywire_vitals.json"

      - name: Upload RAW JSON (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: skywire_raw_${{ steps.date.outputs.date }}
          path: artifacts/raw/skywire_vitals_${{ steps.date.outputs.date }}.json
          if-no-files-found: error
          retention-days: 10

      # ---------- Sanitize + reporting ----------
      - name: Sanitize JSON + quick report (MD/CSV/PNG)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          python scripts/skywire_vital_report.py \
            --in  "data/${{ steps.date.outputs.date }}/skywire_vitals.json" \
            --out "artifacts/sanitized/skywire_vitals_sanitized_${{ steps.date.outputs.date }}.json" \
            --md  "reports/latest/skywire_vital_report.md" \
            --csv "reports/latest/skywire_vitals_timeseries.csv" \
            --png "reports/latest/success_ratio_avg.png"

      - name: Upload SANITIZED JSON (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: skywire_sanitized_${{ steps.date.outputs.date }}
          path: artifacts/sanitized/skywire_vitals_sanitized_${{ steps.date.outputs.date }}.json
          if-no-files-found: error
          retention-days: 10

      - name: Upload report bundle (latest/)
        uses: actions/upload-artifact@v4
        with:
          name: skywire_report_latest_${{ steps.date.outputs.date }}
          path: |
            reports/latest/skywire_vital_report.md
            reports/latest/skywire_vitals_timeseries.csv
            reports/latest/success_ratio_avg.png
          if-no-files-found: error
          retention-days: 10

      # ---------- Snapshot + commit ----------
      - name: Commit & push daily snapshot
        run: |
          set -euo pipefail
          mkdir -p "reports/${{ steps.date.outputs.date }}"
          rsync -a --delete "reports/latest/" "reports/${{ steps.date.outputs.date }}/"
          git config user.name  "sigma-bot"
          git config user.email "sigma-bot@deepkang.labs"
          git add "data/${{ steps.date.outputs.date }}/skywire_vitals.json" \
                  "reports/latest" "reports/${{ steps.date.outputs.date }}" || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(vitals): Skywire capture & report for ${{ steps.date.outputs.date }}"
            git pull --rebase
            git push
          else
            echo "Nothing to commit."
          fi
