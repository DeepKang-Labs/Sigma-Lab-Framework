name: SIGMA Node â€” Smoke

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests

      - name: Date (UTC)
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Prepare folders
        run: |
          set -euo pipefail
          mkdir -p "data/${{ steps.date.outputs.date }}"
          mkdir -p mesh/outbox mesh/inbox

      - name: Run Sigma Node (HTTP ping mode)
        env:
          SIGMA_NODE_ID: "sigma-ci-${{ github.run_id }}"
          SKYWIRE_RPC_MODE: "http"
          SKYWIRE_HTTP_BASE: "https://sd.skycoin.com"   # stub HTTP mode
          SIGMA_DATA_ROOT: "data"
          SIGMA_MESH_OUTBOX: "mesh/outbox"
          SIGMA_MESH_INBOX: "mesh/inbox"
          SIGMA_MESH_AGG_EVERY: "3"
          PYTHONPATH: "${{ github.workspace }}"          # ðŸ‘ˆ pour rÃ©soudre `from scripts...`
        run: |
          set -euo pipefail
          echo "[Info] PYTHONPATH=$PYTHONPATH"
          python scripts/sigma_node.py

      - name: Collect artifacts
        run: |
          set -euo pipefail
          ls -al "data/${{ steps.date.outputs.date }}" || true
          ls -al mesh || true

      - name: Upload artifacts (heartbeat)
        uses: actions/upload-artifact@v4
        with:
          name: sigma_heartbeat_${{ steps.date.outputs.date }}
          path: data/${{ steps.date.outputs.date }}/sigma_heartbeat.json
          if-no-files-found: warn
          retention-days: 7

      - name: Upload artifacts (model)
        uses: actions/upload-artifact@v4
        with:
          name: sigma_model_${{ steps.date.outputs.date }}
          path: data/${{ steps.date.outputs.date }}/sigma_model.json
          if-no-files-found: warn
          retention-days: 7

      - name: Upload artifacts (mesh outbox & inbox)
        uses: actions/upload-artifact@v4
        with:
          name: sigma_mesh_${{ steps.date.outputs.date }}
          path: |
            mesh/outbox/**
            mesh/inbox/**
          if-no-files-found: warn
          retention-days: 7
