name: Sigma Node Smoke Test
on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Date (UTC)
        id: date
        run: echo "date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Prepare folders
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          mkdir -p "$ARTIFACTS_ROOT/heartbeat"
          mkdir -p "$ARTIFACTS_ROOT/mesh/inbox"
          mkdir -p "$ARTIFACTS_ROOT/mesh/outbox"
          mkdir -p "$ARTIFACTS_ROOT/mesh/archive"
          mkdir -p "$ARTIFACTS_ROOT/model"

      # ---------- Mod√®le local (sans HEREDOC) ----------
      - name: Initialize local model (zero-weights)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          MODEL="$ARTIFACTS_ROOT/model/local_model.json"
          if [ ! -f "$MODEL" ]; then
            export MODEL
            python - <<'PY'
import os, json
path = os.environ["MODEL"]
os.makedirs(os.path.dirname(path), exist_ok=True)
data = {
  "version": "0.1.0",
  "updated_at": None,
  "weights": {
    "latency_mean_ms": 0.0,
    "availability_score": 0.0,
    "transport_density": 0.0
  }
}
with open(path, "w", encoding="utf-8") as f:
    json.dump(data, f, indent=2)
print(f"‚úÖ Created zeroed model: {path}")
PY
          else
            echo "‚ÑπÔ∏è Model already exists: $MODEL"
          fi

      - name: Run Sigma Node (HTTP ping mode)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python scripts/sigma_node.py

      - name: Mesh | Federate (produce delta)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python scripts/mesh_federate.py

      - name: Mesh | Apply (consume inbox)
        env:
          ARTIFACTS_ROOT: artifacts
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD"
          python scripts/mesh_apply.py

      - name: Build manifest (r√©cap des artefacts)
        run: |
          set -euo pipefail
          python - <<'PY'
import os, json
root = "artifacts"
summary = {
  "heartbeat_exists": os.path.exists(os.path.join(root, "heartbeat", "heartbeat.json")),
  "model_exists": os.path.exists(os.path.join(root, "model", "local_model.json")),
  "outbox": len(os.listdir(os.path.join(root, "mesh", "outbox"))) if os.path.isdir(os.path.join(root, "mesh", "outbox")) else 0,
  "inbox": len(os.listdir(os.path.join(root, "mesh", "inbox"))) if os.path.isdir(os.path.join(root, "mesh", "inbox")) else 0,
  "archive": len(os.listdir(os.path.join(root, "mesh", "archive"))) if os.path.isdir(os.path.join(root, "mesh", "archive")) else 0,
}
os.makedirs(root, exist_ok=True)
with open(os.path.join(root, "manifest.json"), "w", encoding="utf-8") as f:
  json.dump(summary, f, indent=2)
print("üì¶ Manifest:", json.dumps(summary, indent=2))
PY

      - name: Upload ‚Äî manifest
        uses: actions/upload-artifact@v4
        with:
          name: sigma_manifest_${{ steps.date.outputs.date }}
          path: artifacts/manifest.json
          if-no-files-found: warn
          retention-days: 7

      - name: Upload ‚Äî data day
        uses: actions/upload-artifact@v4
        with:
          name: sigma_data_${{ steps.date.outputs.date }}
          path: artifacts/model/local_model.json
          if-no-files-found: warn
          retention-days: 7
